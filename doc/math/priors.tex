\documentclass{amsart}
\usepackage{graphicx}
\usepackage{fancyhdr}
\usepackage{verbatim}
\usepackage{bm}
\usepackage[colorlinks=true, urlcolor=blue, citecolor=blue, linkcolor=blue, book
marks=true, ]{hyperref}
\usepackage[top=3cm,right=3cm,left=3cm]{geometry}

\DeclareMathOperator{\erf}{erf}
\newcommand{\D}[2]{\ensuremath{\frac{d{#1}}{d{#2}}}}
\newcommand{\Dp}[2]{\ensuremath{\frac{\partial{#1}}{\partial{#2}}}}

\begin{document}

\section{Definitions}

\begin{itemize}
\item $x$: weighted pixel vector
\item $\Sigma$: pixel covariance matrix (assumed to be diagonal)
\item $\phi$: nonlinear parameters
\item $\mu$: linear parameters (coefficients)
\end{itemize}

The coefficient prior is defined as

\begin{equation}
  P(\mu|\phi) = e^{-\frac{1}{2}(\mu-y)^T F (\mu-y)} g(\mu)
\end{equation}

which must of course be normalized.

\section{Bayesian Probabilities}

\begin{eqnarray}
  P(\phi,\mu|x) &=& P(x|\phi,\mu)
  \frac{P(\phi,\mu)}{P(x)} \\
  P(\phi|x)P(\mu|x,\phi) &=&
  P(x|\phi,\mu)\frac{P(\mu|\phi) P(\phi)}{P(x)}
  \\
  P(\phi|x) &=& \frac{P(\phi)}{P(x)}
  \int d\mu P(\mu|\phi) P(x|\phi,\mu) \\
  &=& \frac{P(\phi)}{P(x)} P(x|\phi)
\end{eqnarray}

\section{Coefficient Marginalization}

\begin{eqnarray}
  q(\mu,\phi) &\equiv& -\ln P(x|\phi,\mu) 
  - \ln P(\mu|\phi) \\ &=& 
  \frac{1}{2}(A\mu - x)^T\!(A\mu - x)
  + \frac{1}{2} \left(\mu - y\right)^T\! 
  F \left(\mu - y\right) + \frac{1}{2}\ln\left|2\pi\Sigma\right|
  - \ln g(\mu) \\
  &=& s(\mu,\phi) - \ln g(r) \\
  s(\mu,\phi) &\equiv& \frac{1}{2}(A\mu - x)^T\!(A\mu - x)
  + \frac{1}{2} \left(\mu - y\right)^T\! 
  F \left(\mu - y\right) + \frac{1}{2}\ln\left|2\pi\Sigma\right|
\end{eqnarray}

\begin{eqnarray}
  \Dp{s}{\mu} &=& A^T(A\mu-x) + F \left(\mu - y\right) \\
  \Dp{^2s}{\mu^2} &=& A^T\!A + F \equiv H \\
  \hat{\mu} &=& H^{-1}(A^T\!x + Fy)
\end{eqnarray}

\begin{eqnarray}
  s(\mu,\phi) &=& s(\hat{\mu},\phi) + \frac{1}{2}
  \left(\mu - \hat{\mu}\right)^T\! H 
  \left(\mu - \hat{\mu}\right) \\
  q(\mu,\phi) &=& s(\hat{\mu},\phi) + \frac{1}{2}
  \left(\mu - \hat{\mu}\right)^T\! H 
  \left(\mu - \hat{\mu}\right) 
  - \ln g(\mu) \\
  q(\mu,\phi) &=& s(\hat{\mu},\phi) 
  - \frac{1}{2}\ln\left|2\pi H^{-1}\right|
  + \frac{1}{2}
  \left(\mu - \hat{\mu}\right)^T\! H 
  \left(\mu - \hat{\mu}\right) 
  + \frac{1}{2}\ln\left|2\pi H^{-1}\right|
  - \ln g(\mu)
\end{eqnarray}

\begin{eqnarray}
  P(x|\phi) &=& \int\!e^{-q(\mu,\phi)}d\mu \\
  &=& 
  \left|\frac{H}{2\pi}\right|^{-1/2}\!e^{-s(\hat{\mu},\phi)}
  \left[ \int\!\Phi\!\left(\mu|\hat{\mu},H^{-1}\right) g(\mu,\phi)\,d\mu \right] \\
  &\approx&
  \left|\frac{H}{2\pi}\right|^{-1/2}\!e^{-s(\hat{\mu},\phi)}
  \left[\frac{1}{N}\sum_{n=1}^N g(\mu_n)\right]
  \label{eqn:marginalization}
\end{eqnarray}

where $\mu_n$ are drawn from a multivariate normal with mean
$\hat{\mu}$ and covariance $H^{-1}$.

\end{document}
